<div *ngIf="loading">Loading...</div>
<div *ngIf="error" class="error">{{ error }}</div>
<div *ngIf="!loading && !error">
  <div class="tab-group">
    <button type="button" [class.active]="activeTab === 'basic'" (click)="activeTab = 'basic'">Basic Information</button>
    <button type="button" [class.active]="activeTab === 'contact'" (click)="activeTab = 'contact'">Contact Information</button>
  </div>
  <div class="tab-content">
    <form class="prefix-form" *ngIf="activeTab === 'basic'" #identityForm="ngForm">

      <label for="prefix">Prefix</label>
      <select id="prefix" [(ngModel)]="selectedPrefix" name="prefix">
        <option [ngValue]="null">Select a prefix</option>
        <option *ngFor="let prefix of prefixes" [ngValue]="prefix.prefixsuffixid">{{ prefix.description }}</option>
      </select>

  <label for="firstName" class="required-label">First Name <span class="required-asterisk">*</span></label>
  <input id="firstName" name="firstName" [(ngModel)]="firstName" required [ngClass]="'required-field'" />

      <div class="form-group">
        <label for="middleName">Middle Name</label>
        <div class="middle-name-row" style="display: flex; align-items: center; gap: 1em;">
          <input id="middleName" name="middleName" [(ngModel)]="middleName" [disabled]="noMiddleName" [ngClass]="noMiddleName ? 'nmn-disabled required-field' : 'optional-field'" />
          <label class="nmn-checkbox-label" style="margin: 0; display: flex; align-items: center;">
            <input type="checkbox" [(ngModel)]="noMiddleName" (change)="onNoMiddleNameChange()" style="margin-right: 0.25em;" />
            <span class="nmn-checkbox-text">No Middle Name</span>
          </label>
        </div>
      </div>

  <label for="lastName" class="required-label">Last Name <span class="required-asterisk">*</span></label>
  <input id="lastName" name="lastName" [(ngModel)]="lastName" required [ngClass]="'required-field'" />

      <label for="suffix">Suffix</label>
      <select id="suffix" [(ngModel)]="selectedSuffix" name="suffix">
        <option [ngValue]="null">Select a suffix</option>
        <option *ngFor="let suffix of suffixes" [ngValue]="suffix.prefixsuffixid">{{ suffix.description }}</option>
      </select>

  <label for="previousLastName">Previous Last Name</label>
  <input id="previousLastName" name="previousLastName" [(ngModel)]="previousLastName" [ngClass]="'optional-field'" />

  <label for="preferredName">Preferred Name</label>
  <input id="preferredName" name="preferredName" [(ngModel)]="preferredName" [ngClass]="'optional-field'" />

  <label for="dob" class="required-label">Date of Birth <span class="required-asterisk">*</span></label>
  <input id="dob" name="dob" type="date" [(ngModel)]="dob" required [ngClass]="'required-field'" />

  <label for="ssn" class="required-label">Social Security Number <span class="required-asterisk">*</span></label>
  <input id="ssn" name="ssn" [(ngModel)]="ssn" required maxlength="11" placeholder="XXX-XX-XXXX" [ngClass]="'required-field'" [value]="maskedSsn" (input)="ssn = $event.target.value" />

  <label for="sex" class="required-label">Sex <span class="required-asterisk">*</span></label>
  <select id="sex" name="sex" [(ngModel)]="selectedSex" required [ngClass]="'required-field'">
        <option [ngValue]="null">Select sex</option>
        <option *ngFor="let sex of sexes" [ngValue]="sex.sexid">{{ sex.description }}</option>
      </select>


  <label for="countryOfBirth" class="required-label">Country of Birth <span class="required-asterisk">*</span></label>
    <select id="countryOfBirth" name="countryOfBirth" [(ngModel)]="selectedCountry" (ngModelChange)="onCountryChange()" [ngClass]="'optional-field'">
        <option [ngValue]="null">Select a country</option>
        <option *ngFor="let country of countries" [ngValue]="country.geographyId">{{ country.geographyName }}</option>
      </select>

      <ng-container *ngIf="selectedCountry">
        <ng-container *ngIf="isUsOrCanada; else stateTextField">
          <label for="state" class="required-label">State of Birth <span class="required-asterisk">*</span></label>
          <select id="state" name="state" [(ngModel)]="selectedState" required [ngClass]="'required-field'">
            <option [ngValue]="null">Select a state</option>
            <option *ngFor="let state of states" [ngValue]="state.geographyId">{{ state.geographyName }}</option>
          </select>
        </ng-container>
        <ng-template #stateTextField>

<!--          <label for="state" class="required-label">State of Birth <span class="required-asterisk">*</span></label>-->
            <label for="state">State of Birth <span class="required-asterisk">*</span></label>
          <input id="state" name="state" [(ngModel)]="stateText" required [ngClass]="'required-field'" />
        </ng-template>
      </ng-container>

  <label for="city" class="required-label">City of Birth <span class="required-asterisk">*</span></label>
  <input id="city" name="city" [(ngModel)]="city" required [ngClass]="'required-field'" />

    </form>
    <div *ngIf="activeTab === 'basic'" class="button-row">
      <button type="button" class="btn-cancel" (click)="onCancel()">Cancel</button>
      <div class="button-group-right">
        <button type="button" class="btn-back" (click)="onBack()">Back</button>
        <button type="button" class="btn-next" (click)="onNext()">Next</button>
      </div>
    </div>
  <ng-container *ngIf="activeTab === 'contact'">
    <div class="contact-card">
      <h3>Email</h3>
      <label for="emailType" class="required-label">Email Type<span class="required-asterisk">*</span></label>
      <select id="emailType" name="emailType" [(ngModel)]="selectedEmailType" required>
        <option [ngValue]="null">Select email type</option>
        <option *ngFor="let type of emailTypes" [ngValue]="type.contactTypeId">{{ type.contactTypeName }}</option>
      </select>
      <label for="primaryEmail" class="required-label">Primary Email Address<span class="required-asterisk">*</span></label>
      <input id="primaryEmail" name="primaryEmail" [(ngModel)]="primaryEmail" required type="email" />
    </div>
    <div class="contact-card">
      <h3>Phone</h3>
      <label for="phoneType" class="required-label">Phone Type<span class="required-asterisk">*</span></label>
      <select id="phoneType" name="phoneType" [(ngModel)]="selectedPhoneType" required>
        <option [ngValue]="null">Select phone type</option>
        <option *ngFor="let type of phoneTypes" [ngValue]="type.contactTypeId">{{ type.contactTypeName }}</option>
      </select>
      <label for="primaryPhone" class="required-label">Primary Phone Number<span class="required-asterisk">*</span></label>
      <input id="primaryPhone" name="primaryPhone" [(ngModel)]="primaryPhone" required />
    </div>
    <div class="contact-card">
      <h3>Postal Address</h3>
      <label for="addressType" class="required-label">Address Type<span class="required-asterisk">*</span></label>
      <select id="addressType" name="addressType" [(ngModel)]="selectedAddressType" required>
        <option [ngValue]="null">Select address type</option>
        <option *ngFor="let type of addressTypes" [ngValue]="type.contactTypeId">{{ type.contactTypeName }}</option>
      </select>
      <label for="addressLine1" class="required-label">Address Line 1<span class="required-asterisk">*</span></label>
      <input id="addressLine1" name="addressLine1" [(ngModel)]="addressLine1" required />
      <label for="addressLine2">Address Line 2</label>
      <input id="addressLine2" name="addressLine2" [(ngModel)]="addressLine2" />
      <label for="contactCountry" class="required-label">Country<span class="required-asterisk">*</span></label>
      <select id="contactCountry" name="contactCountry" [(ngModel)]="contactSelectedCountry" (ngModelChange)="onContactCountryChange()" required>
        <option [ngValue]="null">Select a country</option>
        <option *ngFor="let country of contactCountryList" [ngValue]="country.geographyId">{{ country.geographyName }}</option>
      </select>
      <ng-container *ngIf="contactSelectedCountry">
        <ng-container *ngIf="isContactUsOrCanada; else contactStateTextField">
          <label for="contactState" class="required-label">State<span class="required-asterisk">*</span></label>
          <select id="contactState" name="contactState" [(ngModel)]="contactSelectedState" required>
            <option [ngValue]="null">Select a state</option>
            <option *ngFor="let state of contactStates" [ngValue]="state.geographyId">{{ state.geographyName }}</option>
          </select>
        </ng-container>
        <ng-template #contactStateTextField>
          <label for="contactState" class="required-label">State<span class="required-asterisk">*</span></label>
          <input id="contactState" name="contactState" [(ngModel)]="contactStateText" required />
        </ng-template>
      </ng-container>
      <label for="contactCity" class="required-label">City<span class="required-asterisk">*</span></label>
      <input id="contactCity" name="contactCity" [(ngModel)]="contactCity" required />
      <label for="contactZip" class="required-label">ZIP Code<span class="required-asterisk">*</span></label>
      <input id="contactZip" name="contactZip" [(ngModel)]="contactZip" required />
    </div>
    <!-- Button Row for Contact Information tab -->
    <div class="button-row">
      <button type="button" class="btn-cancel" (click)="onCancel()">Cancel</button>
      <div class="button-group-right">
        <button type="button" class="btn-back" (click)="onBack()">Back</button>
        <button type="button" class="btn-next" (click)="onNext()">Save</button>
      </div>
    </div>
  </ng-container>